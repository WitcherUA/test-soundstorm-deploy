name: Local Deploy test-soundstorm

on:
  push:
    branches:
      - pipeline-setup

jobs:
  build-and-push:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read VERSION file
        id: read
        run: |
          TAG=$(tr -d '\n\r ' < VERSION)
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build image
        run: |
          docker build -t witcherua/test-soundstorm:${{ env.TAG }} .

      - name: Push image
        run: |
          docker push witcherua/test-soundstorm:${{ env.TAG }}

  deploy:
    runs-on: self-hosted
    needs: build-and-push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read VERSION file
        id: read
        run: |
          TAG=$(tr -d '\n\r ' < VERSION)
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Debug tag
        run: 'echo "üìå –î–µ–ø–ª–æ–π –≤–µ—Ä—Å—ñ—ó: ${{ env.TAG }}"'


      - name: Deploy to local VM
        run: |
          IMAGE="witcherua/test-soundstorm:${{ env.TAG }}"

          echo "üõë –ó—É–ø–∏–Ω–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          sudo docker stop test-soundstorm || true
          sudo docker rm test-soundstorm || true

          echo "üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑—É..."
          sudo docker pull $IMAGE

          echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          sudo docker run -d \
            --name test-soundstorm \
            --restart unless-stopped \
            -p 80:80 \
            -p 443:443 \
            -v /etc/letsencrypt:/etc/letsencrypt:ro \
            $IMAGE

          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
