name: Auto Deploy test-soundstorm

on:
  workflow_dispatch:
    inputs:
      version:
        description: '–í–µ—Ä—Å—ñ—è –¥–µ–ø–ª–æ—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, v13)'
        required: true
        default: 'v13'

  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    env:
      DEPLOY_VERSION: ${{ github.event.inputs.version || 'v13' }}

    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
        uses: actions/checkout@v3

      - name: –í–∏–≤—ñ–¥ –≤–µ—Ä—Å—ñ—ó –¥–µ–ø–ª–æ—é
        run: echo "üìå –î–µ–ø–ª–æ–π –≤–µ—Ä—Å—ñ—ó: $DEPLOY_VERSION"

      - name: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ä—Ç—É 80 —ñ –∑—É–ø–∏–Ω–∫–∞ nginx
        run: |
          if ss -ltn | grep ':80 '; then
            echo "‚ö†Ô∏è –ü–æ—Ä—Ç 80 –∑–∞–π–Ω—è—Ç–∏–π. –ó—É–ø–∏–Ω—è—î–º–æ nginx..."
            sudo systemctl stop nginx || true
          fi

      - name: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤
        run: |
          echo "üîí –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤..."
          sudo ls /etc/letsencrypt/live/test.soundstorm.pp.ua/fullchain.pem || \
          (echo "‚ùå –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!" && exit 1)

      - name: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±—Ä–∞–∑—É
        run: |
          echo "üì¶ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±—Ä–∞–∑—É witcherua/test-soundstorm:$DEPLOY_VERSION"
          sudo docker pull witcherua/test-soundstorm:$DEPLOY_VERSION

      - name: –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: |
          sudo docker stop test-soundstorm || true
          sudo docker rm test-soundstorm || true

      - name: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤–µ—Ä—Å—ñ—ó $DEPLOY_VERSION"
          sudo docker run -d \
            --name test-soundstorm \
            -v /etc/letsencrypt:/etc/letsencrypt:ro \
            -p 80:80 -p 443:443 \
            --restart unless-stopped \
            witcherua/test-soundstorm:$DEPLOY_VERSION

      - name: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
        run: sudo docker ps -a | grep test-soundstorm
