name: Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read VERSION file
        run: |
          TAG=$(tr -d '\n\r ' < VERSION)
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build image
        run: docker build -t ${{ secrets.DOCKERHUB_REPO }}:${{ env.TAG }} .

      - name: Push image
        run: docker push ${{ secrets.DOCKERHUB_REPO }}:${{ env.TAG }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read VERSION file
        run: |
          TAG=$(tr -d '\n\r ' < VERSION)
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VM_SSH_KEY }}

      - name: Deploy to AWS VM
        run: |
          IMAGE="${{ secrets.DOCKERHUB_REPO }}:${{ env.TAG }}"
          ssh -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} "
            set -e
            docker stop test-soundstorm || true
            docker rm test-soundstorm || true

            docker pull $IMAGE

            docker run -d \
              --name test-soundstorm \
              --restart always \
              -p 80:80 \
              -p 443:443 \
              -v /etc/letsencrypt/live/test.soundstorm.pp.ua/fullchain.pem:/certs/fullchain.pem:ro \
              -v /etc/letsencrypt/live/test.soundstorm.pp.ua/privkey.pem:/certs/privkey.pem:ro \
              $IMAGE
          "

  scan-full:
    name: Full Security Scan (ZAP Daemon Mode)
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Start ZAP in daemon mode
        run: |
          docker run -d --name zap-daemon \
            -p 8080:8080 \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -daemon \
              -port 8080 \
              -host 0.0.0.0 \
              -config api.disablekey=true \
              -config api.addrs.addr.name=.* \
              -config api.addrs.addr.regex=true

      - name: Wait for ZAP to start
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8080/JSON/core/view/version/ > /dev/null; then
              echo "ZAP is ready"
              break
            fi
            echo "Waiting for ZAP..."
            sleep 5
          done

      - name: Spider the target
        run: |
          curl "http://localhost:8080/JSON/spider/action/scan/?url=https://test.soundstorm.pp.ua"
          sleep 10

      - name: Wait for spider to finish
        run: |
          while [ "$(curl -s http://localhost:8080/JSON/spider/view/status/ | jq -r '.status')" != "100" ]; do
            echo "Spider running..."
            sleep 5
          done

      - name: Active scan
        run: |
          curl "http://localhost:8080/JSON/ascan/action/scan/?url=https://test.soundstorm.pp.ua"
          sleep 10

      - name: Wait for active scan to finish
        run: |
          while [ "$(curl -s http://localhost:8080/JSON/ascan/view/status/ | jq -r '.status')" != "100" ]; do
            echo "Active scan running..."
            sleep 5
          done

      - name: Generate HTML report
        run: |
          curl "http://localhost:8080/OTHER/core/other/htmlreport/" -o zap-full-report.html

      - name: Upload Full Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-full-report
          path: zap-full-report.html

  monitor:
    name: Monitoring Check
    runs-on: ubuntu-latest
    needs: scan-full

    steps:
      - name: Check site uptime
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://test.soundstorm.pp.ua)
          echo "HTTP Status: $STATUS" > monitor-report.txt
          if [ "$STATUS" != "200" ]; then
            echo "Site is DOWN or unhealthy" >> monitor-report.txt
            exit 1
          fi

      - name: Check SSL certificate expiration
        run: |
          EXPIRY=$(echo | openssl s_client -connect test.soundstorm.pp.ua:443 -servername test.soundstorm.pp.ua 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          EXPIRY_TS=$(date -d "$EXPIRY" +%s)
          NOW_TS=$(date +%s)
          DAYS_LEFT=$(( (EXPIRY_TS - NOW_TS) / 86400 ))
          echo "SSL expires in $DAYS_LEFT days" >> monitor-report.txt
          if [ "$DAYS_LEFT" -lt 15 ]; then
            echo "SSL certificate is expiring soon!" >> monitor-report.txt
            exit 1
          fi

      - name: Check container health
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            if docker ps --filter "name=test-soundstorm" --filter "status=running" --format "{{.Names}}" | grep -q test-soundstorm; then
              echo "Container is running" >> monitor-report.txt
            else
              echo "Container is NOT running!" >> monitor-report.txt
              exit 1
            fi

      - name: Upload Monitoring Report
        uses: actions/upload-artifact@v4
        with:
          name: monitor-report
          path: monitor-report.txt
